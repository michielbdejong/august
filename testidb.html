<!DOCTYPE html>
  <html lang="en">
    <head>
      <meta charset="utf-8" />
      <title>Test IDB</title>
    </head>
    <body>
    </body>
    <script>
      var startTime, endTime, i, j, data = {}
      for (i=0; i<5000; i++) {
        data[i] = { a: Math.random(), b: Math.random(), c: Math.random(), d: Math.random(), e: Math.random(), f: Math.random() };
      }
      function testLocalStorageBlock() {
        console.log('starting');
        startTime = new Date().getTime();
        for (i=0; i<100; i++) {
          localStorage[i] = JSON.stringify(data);
          data = JSON.parse(localStorage[i]);
        }
        endTime = new Date().getTime();
        console.log('localStorage block', endTime - startTime);
      }
      function testLocalStorageRows() {
        console.log('starting');
        startTime = new Date().getTime();
        for (i=0; i<10; i++) {
          for (j=0; j<5000; j++) {
            localStorage[j] = JSON.stringify(data[j]);
            data[j] = JSON.parse(localStorage[j]);
          }
        }
        endTime = new Date().getTime();
        console.log('localStorage rows', endTime - startTime);
      }

      function nextIterationBlock(db, i, startTime) {
        var transaction = db.transaction(['changes'], 'readwrite');
        var store = transaction.objectStore('changes');
        store.put({
          path: 'a',
          data: data
        }).onsuccess = function() {
          store.get('a').onsuccess = function(evt) {
            data = evt.target.result.data;
          };
        };
        transaction.oncomplete = function() {
          i--;
          if (i === 0) {
            endTime = new Date().getTime();
            console.log('IndexedDB block', endTime - startTime);
          } else {
            nextIterationBlock(db, i, startTime);
          }
        };
      };

      function testIndexedDBBlock() {
        console.log('starting');
        startTime = new Date().getTime();
        var i=0, dbOpen = indexedDB.open('remotestorage', 3);
        dbOpen.onsuccess = function() {
          var db = dbOpen.result;
          nextIterationBlock(db, 100, startTime);
        };
      }

      function nextIterationRows(db, i, startTime) {
        var transaction = db.transaction(['changes'], 'readwrite');
        var j, store = transaction.objectStore('changes');
        for(j=0; j<5000; j++) {
          //console.log('getting', j);
          store.get(j).onsuccess = (function(captureJ) {
            return function(evt) {
              data[captureJ] = evt.target.result;
            };
          });
//          store.put({
  //          path: j,
    //        data: data[j]
      //    });
        }
        transaction.oncomplete = function() {
          i--;
          if (i === 0) {
            endTime = new Date().getTime();
            console.log('IndexedDB rows', endTime - startTime);
          } else {
            nextIterationRows(db, i, startTime);
          }
        };
      };

      function testIndexedDBRows() {
        console.log('starting');
        startTime = new Date().getTime();
        var i=0, dbOpen = indexedDB.open('remotestorage', 3);
        dbOpen.onsuccess = function() {
          var db = dbOpen.result;
          nextIterationRows(db, 1, startTime);
        };
      }


    </script>