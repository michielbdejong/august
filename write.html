<!DOCTYPE html>
<html lang="en">
  <head>
    <script>
      console.log('alpha sync hit');
    </script>
    <meta charset="utf-8" />
    <title>write part of Meute</title>
    <style>
      body { font:15px sans-serif; line-height:1.4em; color:#222 }
      nav {float:left; margin:3em}
      nav div { border-style:solid; border-radius:1em; margin: 1em; padding: 1em}
      nav div table tr td img { width:4em; height:4em; border-radius:1em }
      article table tr td img { width:3em; height:3em; border-radius:1em }
      article {float:left; margin-top:4em; padding:1em; border-style:solid; border-radius:1em}
    </style>
  </head>
  <body>
    <textarea id="editor"></textarea>
  </body>
  <script src="sockethub-client.js"></script>
  <script src="twitter.js"></script>
  <script src="facebook.js"></script>

  <!-- core -->
  <script src="../remotestorage.js/lib/promising.js"></script>
  <script src="../remotestorage.js/src/remotestorage.js"></script>
  <script src="../remotestorage.js/src/eventhandling.js"></script>
  <script src="../remotestorage.js/src/wireclient.js"></script>
  <script src="../remotestorage.js/src/discover.js"></script>
  <script src="../remotestorage.js/src/authorize.js"></script>
  <script src="../remotestorage.js/src/access.js"></script>
  <script src="../remotestorage.js/src/env.js"></script>

  <!-- widget -->
  <script src="../remotestorage.js/src/i18n.js"></script>
  <script src="../remotestorage.js/src/assets.js"></script>
  <script src="../remotestorage.js/src/widget.js"></script>
  <script src="../remotestorage.js/src/view.js"></script>
  
  <!-- baseclient -->
  <script src="../remotestorage.js/lib/tv4.js"></script>
  <script src="../remotestorage.js/lib/Math.uuid.js"></script>
  <script src="../remotestorage.js/src/baseclient.js"></script>
  <script src="../remotestorage.js/src/baseclient/types.js"></script>

  <!-- caching -->
  <script src="../remotestorage.js/src/caching.js"></script>
  <script src="../remotestorage.js/src/sync.js"></script>
  <script src="../remotestorage.js/src/cachinglayer.js"></script>
  <script src="../remotestorage.js/src/indexeddb.js"></script>
  <script src="../remotestorage.js/src/localstorage.js"></script>
  <script src="../remotestorage.js/src/inmemorystorage.js"></script>

  <!-- the rest: -->
  <script src="../remotestorage.js/src/modules.js"></script>
  <script src="../remotestorage.js/src/debug/inspect.js"></script>
  <script src="../remotestorage.js/src/legacy.js"></script>
  <script src="../remotestorage.js/src/googledrive.js"></script>
  <script src="../remotestorage.js/src/dropbox.js"></script>
  <script>remoteStorage = new RemoteStorage();</script>

  <script src="remotestorage-modules/module-utils.js"> </script>
  <script src="remotestorage-modules/inbox.js"> </script>
  <script src="asrender.js"> </script>

    <!-- Create a simple CodeMirror instance -->
    <link rel="stylesheet" href="lib/codemirror.css">
    <script src="lib/codemirror.js"></script>
    <script>
      var myTextarea = document.getElementById('editor');
      var editor = CodeMirror.fromTextArea(myTextarea, {
        mode: "text/html"
      });
    </script>

  <script>
    var templates = {}, posts = [];
    function getTemplate(name) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', 'template/'+name);
      xhr.onload = function() {
        if (xhr.status == 200) {
          templates[name]=xhr.responseText;
          console.log('loaded template', name);
        }
      };
      xhr.send();
    }
    function d(promise) {
      promise.then(function(a) {
        console.log('success', a);
        document.dResult = a;
      }, function(a) {
        console.log('failure', a);
        document.dResult = a;
      });
    }
    remoteStorage._log = true;
    remoteStorage.displayWidget();
    remoteStorage.access.claim('www', 'rw');
    remoteStorage.access.claim('facebook-credentials', 'rw');
    remoteStorage.access.claim('twitter-credentials', 'rw');
    remoteStorage.stopSync();
    document.sockethubClient = SockethubClient.connect({
      host: 'michielbdejong.com',
      path: '/sockethub',
      port: 10550,
      ssl: true,
      tls: true,
      register: {
        secret: '1234567890'
      }
    });

    function getHighestId() {
      return posts.length-1;
    }
    function generateHomePage() {
      var str = templates['homepage.html'], i, feedStr = '<?xml version="1.0" encoding="utf-8"?>\n'
        + '<rss version="2.0">\n'
        + '  <channel>\n'
        + '    <title>Michiel B. de Jong</title>\n'
        + '    <link>https://michielbdejong.com/</link>\n'
        + '    <description>Michiel\'s POSSE feed</description>\n';
      for (i=posts.length-1; i>=0; i--) {
        str += '<article id="'+i+'" class="h-entry"><span style="float:right">'
          + hEntryDate(posts[i].date)+', <a href="/live/'+i+'">michielbdejong.com/live/'+i+'</a></span><h1 class="e-content">'
          + posts[i].text
          + hEntryMarkup(posts[i].date)
          + '</h1></article>\n';
        posts[i].saferText = posts[i].text.split('&').join('&amp;').split('<').join('&gt;');
        feedStr += '    <item>\n'
          + '      <title>'+posts[i].saferText+'</title>\n'
          + '      <link>https://michielbdejong/live/'+i+'</link>\n'
          + '      <guid>https://michielbdejong/live/'+i+'</guid>\n'
          + '      <pubDate>'+posts[i].date.toString()+'</pubDate>\n'
          + '      <description>'+posts[i].saferText+'</description>\n'
          + '    </item>\n'
      }
      return {
        home: str+'</body></html>',
        feed: feedStr + '  </channel>\n</rss>\n'
      };
    }
    function twoPos(a) {
      if (a>9) {
        return a;
      } else {
        return '0'+a;
      }
    }
    function hEntryDate(a) {
      a = new Date(a);
      return a.getUTCFullYear()+'-'+twoPos(a.getUTCMonth()+1)+'-'+twoPos(a.getUTCDate())
        +' '+twoPos(a.getUTCHours())+':'+twoPos(a.getUTCMinutes())+':'+twoPos(a.getUTCSeconds());
    }
    function hEntryMarkup(date, showDetails) {
      return '<span '+(showDetails?'':'style="display:none"')+'><time class="dt-published" datetime="'+hEntryDate(date)+'">'
        + hEntryDate(date)
        + '</time>'
        + '<p>By <a rel="author" class="p-author h-card" href="https://michielbdejong.com/">'
        + '<img class="u-photo" src="/img/60px.jpg" style="border-radius:4em" />'
        + 'Michiel B. de Jong</a></span>';
    }
    function publish(str, syndicate) {
      var date, str1, str2, str3, id, backlink;
      if (posts.length === 0) {
        return 'refusing to publish zero posts! try comparing `posts` to `backup` in the console';
      }
      if (str) {
        date = new Date().toISOString();
        str1 = '<!DOCTYPE html><html><head><title>';
        str2 = '</title>\n<link rel="webmention" href="https://michielbdejong.com:7678/" />\n'
          + '<link rel="author" href="https://michielbdejong.com/" />\n<meta charset="utf-8">\n'
          + '<style>\nbody { background-color: #A3DDDF }\nheader { width: 40em; margin: 5em auto; color: #903030; font-size: 20px }\n'
          + 'article { width: 40em; margin: 5em auto; padding: 3em; border-radius: 1em; background-color: white }\n'
          + 'footer { width: 40em; margin: 5em auto; color: white }\n</style></head><body><header class="h-entry"><h1 class="e-content">';
        id = getHighestId() + 1;
        str3 = '</h1>'+hEntryMarkup(date, true)
          + '<p>This message on my profile feed: <a href="https://michielbdejong.com/#'+id+'">https://michielbdejong.com/#'+id+'</a></p></header></body></html>';
        remoteStorage.scope('/public/www/').storeFile('text/html', 'michielbdejong.com/live/'+id, str1+str+str2+str+str3);
        posts.push({
          text: str,
          date: date
        });
        if (syndicate) {
          sendFacebookCreds();
          sendTwitterCreds();
          //backlink = ' (perma: /live/'+id+')';
          backlink = ' /live/'+id;
          backlink = ' (/live/'+id+')';
          //backlink = ' (michielbdejong.com /live/'+id+')';
          
          fbpost(str+backlink);
          if ((str+backlink).length > 140) {
            str = str.substring(0, 105)+'...';//change this value to 104 after i publish post #999
          }
          tweet(str+backlink);
        }
      }
      var page = generateHomePage();
      remoteStorage.scope('/public/www/').storeFile('text/html', 'michielbdejong.com/index.html', page.home);
      remoteStorage.scope('/public/www/').storeFile('text/html', 'michielbdejong.com/feed.rss', page.feed);
      savePosts();
    }
    function savePosts() {
      remoteStorage.scope('/public/www/').storeFile('application/json', 'michielbdejong.com/posts.json', JSON.stringify(posts));
    }
    function loadPosts() {
      remoteStorage.scope('/public/www/').getFile('michielbdejong.com/posts.json', 0).then(function(a) {
        posts = JSON.parse(a.data);
      }, function(err) {
        console.log('err', err); 
      });
    }
        function doSomething(what) {
      document.sockethubClient.sendObject({
        platform: 'experimental',
        verb: 'post',
        actor: { address: 'a', name: ''},
        object: { text: '', what: what },
        target: []
      });
    }
    function webmention(source, target) {
      doSomething({
        action: 'webmention',
        source: source,
        target: target
      });
    }
    
    var backup = [
      {
        date: "2014-03-01T09:53:53.811Z",
        text: "post zero!"
      },
      {
        date: "2014-03-01T10:53:53.811Z",
        text: "I'm in the process of setting up POSSE. Let's see if I can syndicate this post into a tweet."
      },
      {
        date: "2014-03-01T11:53:53.811Z",
        text: "testing POSSE posting with http://meute.5apps.com  + reSite"
      },
      {
        date: "2014-03-01T12:53:53.811Z",
        text: "three movies in the imdb top 10 http://www.imdb.com/chart/top which i haven't seen yet; time to borrow them from a peer!"
      },
      {
        date: "2014-03-01T13:53:53.811Z",
        text: "the Quattro Formaggi pizza i just had was more like nachos & cheese, but tasty nonetheless"
      },
      {
        date: "2014-03-02T09:53:17.226Z",
        text: "fascinating interview with @leashless - from open source, to world hunger, to bitcoin, to genocides, to lady gaga in space https://www.youtube.com/watch?v=9rys_saLiDA"
      },
      {
        date: "2014-03-04T04:13:59.012Z",
        text: "just got #indieweb private messaging working using just a https textarea (ref http://www.sandeep.io/178)"
      }
    ];
    
    //...
    setTimeout(function() {
      sendFacebookCreds();
      sendTwitterCreds();
    }, 5000);

    getTemplate('homepage.html');
    loadPosts();
  </script>
</html>
