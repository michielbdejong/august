<!DOCTYPE html>
<html lang="en">
  <head>
    <script>
      console.log('alpha sync hit');
    </script>
    <meta charset="utf-8" />
    <title>write part of Meute</title>
    <style>
      body { font:15px sans-serif; line-height:1.4em; color:#222 }
      nav {float:left; margin:3em}
      nav div { border-style:solid; border-radius:1em; margin: 1em; padding: 1em}
      nav div table tr td img { width:4em; height:4em; border-radius:1em }
      article table tr td img { width:3em; height:3em; border-radius:1em }
      article {float:left; margin-top:4em; padding:1em; border-style:solid; border-radius:1em}
    </style>
  </head>
  <body>
    bookmarklet: <a href="javascript:void(window.open('http://write.lolcathost.de:4242/meute/write.html?reblog='+encodeURIComponent(window.location.href)+'&title='+encodeURIComponent(document.title)));">Reblog</a>
    <textarea id="editor"></textarea>
  </body>
  <script src="sockethub-client.js"></script>
  <script src="twitter.js"></script>
  <script src="facebook.js"></script>

  <!-- core -->
  <script src="../remotestorage.js/lib/promising.js"></script>
  <script src="../remotestorage.js/src/remotestorage.js"></script>
  <script src="../remotestorage.js/src/eventhandling.js"></script>
  <script src="../remotestorage.js/src/wireclient.js"></script>
  <script src="../remotestorage.js/src/discover.js"></script>
  <script src="../remotestorage.js/src/authorize.js"></script>
  <script src="../remotestorage.js/src/access.js"></script>
  <script src="../remotestorage.js/src/env.js"></script>

  <!-- widget -->
  <script src="../remotestorage.js/src/i18n.js"></script>
  <script src="../remotestorage.js/src/assets.js"></script>
  <script src="../remotestorage.js/src/widget.js"></script>
  <script src="../remotestorage.js/src/view.js"></script>
  
  <!-- baseclient -->
  <script src="../remotestorage.js/lib/tv4.js"></script>
  <script src="../remotestorage.js/lib/Math.uuid.js"></script>
  <script src="../remotestorage.js/src/baseclient.js"></script>
  <script src="../remotestorage.js/src/baseclient/types.js"></script>

  <!-- caching -->
  <script src="../remotestorage.js/src/caching.js"></script>
  <script src="../remotestorage.js/src/sync.js"></script>
  <script src="../remotestorage.js/src/cachinglayer.js"></script>
  <script src="../remotestorage.js/src/indexeddb.js"></script>
  <script src="../remotestorage.js/src/localstorage.js"></script>
  <script src="../remotestorage.js/src/inmemorystorage.js"></script>

  <!-- the rest: -->
  <script src="../remotestorage.js/src/modules.js"></script>
  <script src="../remotestorage.js/src/debug/inspect.js"></script>
  <script src="../remotestorage.js/src/legacy.js"></script>
  <script src="../remotestorage.js/src/googledrive.js"></script>
  <script src="../remotestorage.js/src/dropbox.js"></script>
  <script>remoteStorage = new RemoteStorage();</script>

  <script src="remotestorage-modules/module-utils.js"> </script>
  <script src="remotestorage-modules/inbox.js"> </script>
  <script src="asrender.js"> </script>

    <!-- Create a simple CodeMirror instance -->
    <link rel="stylesheet" href="lib/codemirror.css">
    <script src="lib/codemirror.js"></script>
    <script>
      var myTextarea = document.getElementById('editor');
      var editor = CodeMirror.fromTextArea(myTextarea, {
        mode: "text/html"
      });
    </script>

  <script>
    var templates = {}, posts = [];
    function getTemplate(name) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', 'template/'+name);
      xhr.onload = function() {
        if (xhr.status == 200) {
          templates[name]=xhr.responseText;
          console.log('loaded template', name);
        }
      };
      xhr.send();
    }
    function d(promise) {
      promise.then(function(a) {
        console.log('success', a);
        document.dResult = a;
      }, function(a) {
        console.log('failure', a);
        document.dResult = a;
      });
    }
    remoteStorage._log = true;
    remoteStorage.displayWidget();
    remoteStorage.access.claim('www', 'rw');
    remoteStorage.access.claim('facebook-credentials', 'rw');
    remoteStorage.access.claim('twitter-credentials', 'rw');
    remoteStorage.stopSync();
    document.sockethubClient = SockethubClient.connect({
      host: 'michielbdejong.com',
      path: '/sockethub',
      port: 10550,
      ssl: true,
      tls: true,
      register: {
        secret: '1234567890'
      }
    });

    function getHighestId() {
      return posts.length-1;
    }
    function generateHomePage() {
      var str = templates['homepage.html'], i, feedStr = '<?xml version="1.0" encoding="utf-8"?>\n'
        + '<rss version="2.0">\n'
        + '  <channel>\n'
        + '    <title>Michiel B. de Jong</title>\n'
        + '    <link>https://michielbdejong.com/</link>\n'
        + '    <description>Michiel\'s POSSE feed</description>\n';
      for (i=posts.length-1; i>=0; i--) {
        if(posts[i].type === 'note') {
          str += '<article id="'+i+'" class="h-entry"><span style="float:right">'
            + hEntryDate(posts[i].date)+', <a href="/live/'+i+'">michielbdejong.com/live/'+i+'</a>'
            + twitterActions(posts[i].tweetId, i)
            + '</span><h1 class="e-content">'
            + aggregateMedia(posts[i].text)
            + hEntryMarkup(posts[i].date, false, posts[i].tweetId)
            + '</h1></article>\n';
          posts[i].saferText = posts[i].text.split('&').join('&amp;').split('<').join('&gt;');
          feedStr += '    <item>\n'
            + '      <title>'+posts[i].saferText+'</title>\n'
            + '      <link>https://michielbdejong/live/'+i+'</link>\n'
            + '      <guid>https://michielbdejong/live/'+i+'</guid>\n'
            + '      <pubDate>'+posts[i].date.toString()+'</pubDate>\n'
            + '      <description>'+posts[i].saferText+'</description>\n'
            + '    </item>\n';
        } else if(posts[i].type === 'article') {
          str += '<article id="'+i+'" class="h-entry"><span style="float:right">'
            + hEntryDate(posts[i].date)+', <a href="/blog/'+posts[i].blogPostId+'.html">michielbdejong.com/blog/'+posts[i].blogPostId+'.html</a></span><h1 class="e-content">'
            + posts[i].text
            + hEntryMarkup(posts[i].date, false, posts[i].tweetId)
            + '</h1></article>\n';
          posts[i].saferText = posts[i].text.split('&').join('&amp;').split('<').join('&gt;');
          feedStr += '    <item>\n'
            + '      <title>'+posts[i].saferText+'</title>\n'
            + '      <link>https://michielbdejong/blog/'+posts[i].blogPostId+'.html</link>\n'
            + '      <guid>https://michielbdejong/blog/'+posts[i].blogPostId+'.html</guid>\n'
            + '      <pubDate>'+posts[i].date.toString()+'</pubDate>\n'
            + '      <description>'+posts[i].saferText+'</description>\n'
            + '    </item>\n';
         }
      }
      return {
        home: str+'</body></html>',
        feed: feedStr + '  </channel>\n</rss>\n'
      };
    }
    function twoPos(a) {
      if (a>9) {
        return a;
      } else {
        return '0'+a;
      }
    }
    function hEntryDate(a) {
      a = new Date(a);
      return a.getUTCFullYear()+'-'+twoPos(a.getUTCMonth()+1)+'-'+twoPos(a.getUTCDate())
        +' '+twoPos(a.getUTCHours())+':'+twoPos(a.getUTCMinutes())+':'+twoPos(a.getUTCSeconds());
    }
    function hEntryMarkup(date, showDetails, tweetId) {
      return '<span '+(showDetails?'':'style="display:none"')+'><time class="dt-published" datetime="'+hEntryDate(date)+'">'
        + hEntryDate(date)
        + '</time>'
        + '<p>By <a rel="author" class="p-author h-card" href="https://michielbdejong.com/">'
        + '<img class="u-photo" src="/img/60px.jpg" style="border-radius:4em" />'
        + ' <a href="https://twitter.com/michielbdejong/status/'+tweetId+' class="u-syndication" rel="syndication">view on Twitter</a>';
        + 'Michiel B. de Jong</a></span>';
    }
    function twitterActions(tweetId, id) {
      if (tweetId) {
        return ' <action do="props" with="https://michielbdejong.com/live/'+id+'">'
           + '<a href="https://twitter.com/intent/favorite?tweet_id='+tweetId+'">Favorite</a></action>'
           + ' <action do="repost" with="https://michielbdejong.com/live/'+id+'">'
           + ' <a href="https://twitter.com/intent/retweet?tweet_id='+tweetId+'">Retweet</a></action>'
           + ' <action do="reply" with="https://michielbdejong.com/live/'+id+'">'
           + ' <a href="https://twitter.com/intent/tweet?in_reply_to='+tweetId+'">Reply</a></action>'
           + ' <a href="https://twitter.com/michielbdejong/status/'+tweetId+' rel="syndication">view on Twitter</a>';
      } else {
        return '';
      }
    }

    function aggregateMedia(str) {
      var i, words = str.split(' '), http = 'http://', https = 'https://', handle = '@', base;
      for (i=0; i<words.length; i++) {
        if (['"', '.', ',', ':', '!'].indexOf(words[i][words[i].length-1]) === -1) {
          base = words[i];
          rest = '';
        } else {
          base = words[i].substring(0, words[i].length-1);
          rest = words[i].substring(words[i].length-1);
        }
        if(words[i].substring(0, http.length) === http || words[i].substring(0, https.length) === https) {
          words[i] = '<a href="'+base+'">'+base+'</a>'+rest;
        } else if(words[i].substring(0, handle.length) === handle) {
          words[i] = '<a href="https://twitter.com/'+base.substring(1)+'">'+base+'</a>'+rest;
        }
      }
      return words.join(' ');
    }
    function createLivePost(postObj) {
      var str1 = '<!DOCTYPE html><html><head><title>',
          str2 = '</title>\n<link rel="webmention" href="https://michielbdejong.com:7678/" />\n'
            + '<link rel="author" href="https://michielbdejong.com/" />\n<meta charset="utf-8">\n'
            + '<style>\nbody { background-color: #A3DDDF }\nheader { width: 40em; margin: 5em auto; color: #903030; font-size: 20px }\n'
            + 'article { width: 40em; margin: 5em auto; padding: 3em; border-radius: 1em; background-color: white }\n'
            + 'footer { width: 40em; margin: 5em auto; color: white }\n</style></head><body><nav><a href="1">first</a> '
            + (postObj.id === 0 ? '' : '<a href="'+(postObj.id-1)+'">previous</a> ')
            + (postObj.id === posts.length-1 ? '' : '<a href="'+(postObj.id+1)+'">next</a> ')
            + '</nav><header class="h-entry"><h1 class="e-content">',
          str3 = '</h1>'+hEntryMarkup(postObj.date, true, postObj.tweetId)
            + '<p>This message on my profile feed: <a href="https://michielbdejong.com/#'+postObj.id+'">https://michielbdejong.com/#'+postObj.id+'</a>'
            + twitterActions(postObj.tweetId, postObj.id)
            + '</p></header></body></html>';
      return str1+postObj.text+str2+aggregateMedia(postObj.text)+str3;
    }
    function publishNote(id) {
      remoteStorage.scope('/public/www/').storeFile('text/html', 'michielbdejong.com/live/'+id, createLivePost(posts[id]));
    }
    function extractTwitterId(url) {
      var urlParts = (url ? url.split('/') : []);
      console.log('extracting twitter id', urlParts);
      if (urlParts.length === 6 && urlParts[0] === 'https:' && urlParts[1] === '' && urlParts[2] === 'twitter.com' && urlParts[4] === 'status') {
        //str = 'RT '+urlParts[3]+': '+....;
        return urlParts[5];
      }
    }
    function publish(str, syndicate, tweetId, likeUrl, inReplyTo) {
      var id, backlink, page, tweetStr, postObj;
      id = getHighestId() + 1;//not threadsafe at all!    
      if (posts.length === 0) {
        return 'refusing to publish zero posts! try comparing `posts` to `backup` in the console';
      }
      if (syndicate) {
        console.log('publish syndicate');
        sendFacebookCreds();
        sendTwitterCreds();
        //backlink = ' (perma: /live/'+id+')';
        backlink = ' /live/'+id;
        backlink = ' (/live/'+id+')';
        //backlink = ' (michielbdejong.com /live/'+id+')';
        
        //if (likeUrl) {
        //  fblike(likeUrl);
        //} else {
          fbpost(str+backlink);
        //}
        if ((str+backlink).length > 140) {
          tweetStr = str.substring(0, 105)+'...';//change this value to 104 after i publish post #999
        } else {
          tweetStr = str;
        }
        
        retweeting = extractTwitterId(likeUrl);
        if (retweeting) {
          console.log('retweeting', retweeting);
          retweet(retweeting, function(obj) {
            publish(obj.text, false, retweeting);//link to original tweet, not to my retweet which would be obj.id_str
          });
        } else {
          if (inReplyTo) {
            webmention('https://michielbdejong.com/live/'+id, inReplyTo);
          }
          tweetReply = extractTwitterId(inReplyTo);
          console.log('tweeting', inReplyTo, tweetReply);
          tweet(tweetStr+backlink, tweetReply, function(tweetId) {
            publish(str, false, tweetId);
          });
        }
      } else {
        if (str) {
          postObj = {
            text: str,
            date: new Date().toISOString(),
            type: 'note',
            tweetId: tweetId,
            id: id,
            likeUrl: likeUrl
          };
          posts.push(postObj);
          if (posts.length != id+1) {
            console.log('new note is not the last post - race condition?');
            return;
          }
          publishNote(id);
        }
        page = generateHomePage();
        remoteStorage.scope('/public/www/').storeFile('text/html', 'michielbdejong.com/index.html', page.home);
        remoteStorage.scope('/public/www/').storeFile('text/html', 'michielbdejong.com/feed.rss', page.feed);
        savePosts();
      }
    }
    function savePosts() {
      remoteStorage.scope('/public/www/').storeFile('application/json', 'michielbdejong.com/posts.json', JSON.stringify(posts));
    }
    function loadPosts() {
      remoteStorage.scope('/public/www/').getFile('michielbdejong.com/posts.json', 0).then(function(a) {
        posts = JSON.parse(a.data);
      }, function(err) {
        console.log('err', err); 
      });
    }
    function doSomething(what) {
      document.sockethubClient.sendObject({
        platform: 'experimental',
        verb: 'post',
        actor: { address: 'a', name: ''},
        object: { text: '', what: what },
        target: []
      });
    }
    function webmention(source, target) {
      doSomething({
        action: 'webmention',
        source: source,
        target: target
      });
    }
    
    var backup = [
      {
        date: "2014-03-01T09:53:53.811Z",
        type: "note",
        text: "post zero!"
      },
      {
        date: "2014-03-01T10:53:53.811Z",
        type: "note",
        text: "I'm in the process of setting up POSSE. Let's see if I can syndicate this post into a tweet."
      },
      {
        date: "2014-03-01T11:53:53.811Z",
        type: "note",
        text: "testing POSSE posting with http://meute.5apps.com  + reSite"
      },
      {
        date: "2014-03-01T12:53:53.811Z",
        type: "note",
        text: "three movies in the imdb top 10 http://www.imdb.com/chart/top which i haven't seen yet; time to borrow them from a peer!"
      },
      {
        date: "2014-03-01T13:53:53.811Z",
        type: "note",
        text: "the Quattro Formaggi pizza i just had was more like nachos & cheese, but tasty nonetheless"
      },
      {
        date: "2014-03-02T09:53:17.226Z",
        type: "note",
        text: "fascinating interview with @leashless - from open source, to world hunger, to bitcoin, to genocides, to lady gaga in space https://www.youtube.com/watch?v=9rys_saLiDA"
      },
      {
        date: "2014-03-04T04:13:59.012Z",
        type: "note",
        text: "just got #indieweb private messaging working using just a https textarea (ref http://www.sandeep.io/178)"
      },
     {
       "text":"It's fun to indiewebify.me! just added a discoverable /feed.rss to my site",
       "date":"2014-03-04T05:26:10.868Z",
       "saferText":"It's fun to indiewebify.me! just added a discoverable /feed.rss to my site",
       "type":"note"
     },
     {
       "text":"\"if you can't curl it, it's not on the web.\" http://indiewebcamp.com/IndieMark#Level_1",
       "date":"2014-03-04T07:01:35.042Z",
       "saferText":"\"if you can't curl it, it's not on the web.\" http://indiewebcamp.com/IndieMark#Level_1",
       "type":"note"
     },
     {
       "text":"I think I reached an IndieMark score of 1.5 (level 1 completed, cherry-picked from level 2) #indieweb",
       "date":"2014-03-04T07:17:09.351Z",
       "saferText":"I think I reached an IndieMark score of 1.5 (level 1 completed, cherry-picked from level 2) #indieweb",
       "type":"note"
     },
     {
       "text":"experimenting with parenthetical permashortlink citation","date":"2014-03-04T08:39:56.245Z","saferText":"experimenting with parenthetical permashortlink citation","type":"note"},{"text":"Testing out minimalistic variation on (ttk.me t4Pc2) style POSSE backlink","date":"2014-03-04T08:47:05.168Z","saferText":"Testing out minimalistic variation on (ttk.me t4Pc2) style POSSE backlink","type":"note"
     },{
       "text":"maybe try what that looks like with parenthesis around it - is the POSSE original of this tweet easily discoverable?","date":"2014-03-04T08:50:00.190Z","saferText":"maybe try what that looks like with parenthesis around it - is the POSSE original of this tweet easily discoverable?","type":"note"
     },{
       "text":"Joern Drever about why he works for ownCloud: http://www.butonic.de/2013/12/17/why-i-work-on-owncloud/","date":"2014-03-07T03:57:01.793Z","saferText":"Joern Drever about why he works for ownCloud: http://www.butonic.de/2013/12/17/why-i-work-on-owncloud/","type":"note"
     },{
       "date":"2011-07-01T00:00:00.000Z","type":"article","text":"Software freedom on the web https://michielbdejong.com/blog/1.html","saferText":"Software freedom on the web https://michielbdejong.com/blog/1.html","blogPostId":1
     },{
       "date":"2011-08-01T00:00:00.000Z","type":"article","text":"Why browsers should offer login https://michielbdejong.com/blog/2.html","blogPostId":2,"saferText":"Why browsers should offer login https://michielbdejong.com/blog/2.html"
     },{
       "date":"2012-02-01T00:00:00.000Z","type":"article","text":"On the origin of computational complexity https://michielbdejong.com/blog/3.html","blogPostId":3,"saferText":"On the origin of computational complexity https://michielbdejong.com/blog/3.html"
     },{
       "date":"2012-08-01T00:00:00.000Z","type":"article","text":"The countries and Crime https://michielbdejong.com/blog/4.html","blogPostId":4,"saferText":"The countries and Crime https://michielbdejong.com/blog/4.html"
     },{
       "date":"2013-02-01T00:00:00.000Z","type":"article","text":"Reboot to virtual prosperity https://michielbdejong.com/blog/5.html","blogPostId":5,"saferText":"Reboot to virtual prosperity https://michielbdejong.com/blog/5.html"
     },{
       "date":"2013-12-01T00:00:00.000Z","type":"article","text":"Wifi 4 Change https://michielbdejong.com/blog/6.html","blogPostId":6,"saferText":"Wifi 4 Change https://michielbdejong.com/blog/6.html"
     },{
       "date":"2013-07-01T00:00:00.000Z","type":"article","text":"Four simple tips for web page providers https://michielbdejong.com/blog/7.html","blogPostId":7,"saferText":"Four simple tips for web page providers https://michielbdejong.com/blog/7.html"
     }
    ];
    
    //...
    setTimeout(function() {
      sendFacebookCreds();
      sendTwitterCreds();
      if (window.location.search.length) {
        var parts, str, prefix = '?reblog=';
        if (window.location.search.substring(0, prefix.length) === prefix) {
          parts = window.location.search.substring(prefix.length).split('&title=');
          str = '"'+decodeURIComponent(parts[1])+'" '+decodeURIComponent(parts[0]);
          console.log('will autoreblog in 10 secs', str);
          setTimeout(function() {
            publish(str, true, undefined, decodeURIComponent(parts[1]));
            console.log('autoreblogged. will close window in 10 secs');
            setTimeout(function() {
              window.close();
            }, 10000);
          }, 10000);
        }
      }
    }, 5000);

    getTemplate('homepage.html');
    loadPosts();
  </script>
</html>
