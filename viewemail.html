<!DOCTYPE html>
<html lang="en">
  <head>
    <script>
      console.log('alpha sync hit');
    </script>
    <meta charset="utf-8" />
    <title>Meute - an unhosted messages/contacts/search app</title>
    <style>
      body { font:15px sans-serif; line-height:1.4em; color:#222 }
      nav {float:left; margin:3em}
      nav div { border-style:solid; border-radius:1em; margin: 1em; padding: 1em}
      nav div table tr td img { width:4em; height:4em; border-radius:1em }
      article table tr td img { width:3em; height:3em; border-radius:1em }
      article {float:left; margin-top:4em; padding:1em; border-style:solid; border-radius:1em}
    </style>
  </head>
  <body>
    <article>
      <h3>Email:</h3>
      <div id="view">
      </div>
    </article>
  </body>
  <script>
    showEmail = (function() {
      var pos, conversationName = '';
      pos = window.location.href.indexOf('#');
      if (pos) {
        conversationName = decodeURIComponent(window.location.href.substring(pos+1));
      }
      if (conversationName.length) {
        localStorage.conversationName = conversationName;
      } else {
        conversationName = localStorage.conversationName;
      }
      return function () {
        var conversation, activity, i;
        console.log('showing', conversationName);
        if (conversationName && conversationName.length) {
          conversation = remoteStorage.inbox.getActivityInterval(0, 10, localStorage.conversationName);
          console.log('conversation', conversationName, conversation);
          document.getElementById('view').innerHTML = '';
          for(i in conversation) {
            activity = conversation[i];
            console.log('item', conversationName, i, activity);
            if (activity && activity.object && activity.object.messageId) {
              console.log('getting', activity.object.messageId);
              remoteStorage.email.getMessage(activity.object.messageId).then(function(obj) {
                console.log('got', activity.object.messageId);
                document.getElementById('view').innerHTML += window.asrender.toTable(obj);        
              });
            } else {
               console.log('activity has no obj.object.messageId! Not retrieving real email message object.');
               document.getElementById('view').innerHTML += window.asrender.toTable(activity);
            }
          }
        } else {
          console.log('no conversationName');
        }
      };
    })();
  </script>
<!--  <script src="sockethub-client.js"></script> -->

  <!-- core -->
  <script src="../remotestorage.js/lib/promising.js"></script>
  <script src="../remotestorage.js/src/remotestorage.js"></script>
  <script src="../remotestorage.js/src/eventhandling.js"></script>
  <script src="../remotestorage.js/src/wireclient.js"></script>
  <script src="../remotestorage.js/src/discover.js"></script>
  <script src="../remotestorage.js/src/authorize.js"></script>
  <script src="../remotestorage.js/src/access.js"></script>
  <script src="../remotestorage.js/src/env.js"></script>

  <!-- widget -->
  <script src="../remotestorage.js/src/i18n.js"></script>
  <script src="../remotestorage.js/src/assets.js"></script>
  <script src="../remotestorage.js/src/widget.js"></script>
  <script src="../remotestorage.js/src/view.js"></script>
  
  <!-- baseclient -->
  <script src="../remotestorage.js/lib/tv4.js"></script>
  <script src="../remotestorage.js/lib/Math.uuid.js"></script>
  <script src="../remotestorage.js/src/baseclient.js"></script>
  <script src="../remotestorage.js/src/baseclient/types.js"></script>

  <!-- caching -->
  <script src="../remotestorage.js/src/caching.js"></script>
  <script src="../remotestorage.js/src/sync.js"></script>
  <script src="../remotestorage.js/src/cachinglayer.js"></script>
  <script src="../remotestorage.js/src/indexeddb.js"></script>
  <script src="../remotestorage.js/src/localstorage.js"></script>
  <script src="../remotestorage.js/src/inmemorystorage.js"></script>

  <!-- the rest: -->
  <script src="../remotestorage.js/src/modules.js"></script>
  <script src="../remotestorage.js/src/debug/inspect.js"></script>
  <script src="../remotestorage.js/src/legacy.js"></script>
  <script src="../remotestorage.js/src/googledrive.js"></script>
  <script src="../remotestorage.js/src/dropbox.js"></script>
  <script>remoteStorage = new RemoteStorage();</script>


  <script src="remotestorage-modules/module-utils.js"> </script>
  <script src="remotestorage-modules/inbox.js"> </script>
  <script src="remotestorage-modules/email.js"> </script>
  <script src="remotestorage-modules/contacts.js"> </script>
  <script src="remotestorage-modules/money.js"> </script>
  <script src="remotestorage-modules/sockethub.js"> </script>
  <script src="irc.js"></script>
  <script src="asrender.js"> </script>
  <script src="messaging.js"> </script>
  <script src="expimp.js"> </script>
  <script src="tests.js"> </script>
  <script>
    var timer, done = false;
    remoteStorage.scope('/').on('change', function() { 
      if(timer) {
        clearTimeout(timer);
      }
      timer = setTimeout(function() {
        if (!done) {
          showEmail();
          done = true;
        }
      }, 250);
    });
    document.onSockethubReady = function() {
//      joinIrc();
//      fetchEmail();
//      go(0);
    };
    function go(i) {
      remoteStorage.stopSync();
      remoteStorage.inbox.onActivity(function(timestamp, obj) {
        document.getElementById('update-button').style.background = 'green';
      });
      document.getElementById('homefeed').innerHTML =
        document.messaging.getFeedTable(0)
        + '<input type="submit" value="older..." onmousedown="go('+(i+1)+');" />';
      document.getElementById('update-button').style.background = 'white';
  //    remoteStorage.displayWidget();
    }
    function fetchEmail() {
      document.fetchEmails(0, 10, false);
    }
    function joinIrc() {
      joinRooms('michielbdejong', ['#meute']);
    }
    console.log('alpha sync loaded');
    remoteStorage.on('ready', function() {
      console.log('remoteStorage ready');
    });
    remoteStorage.sockethub.writeConfig({
      host: '162.242.174.14',
      port: 10550,
      tls: false,
      secret: '1234567890'
    });
/*    remoteStorage.email.getAll('', function(objects) {
      var str = '<table><tr><td>From</td><td>To</td><td>subject</td></tr>';
      for(var i=0; i<objects.length; i++) {
        str+='<tr><td>'+objects[i].actor[0].name ||objects[i].actor[0].address+'</td<td>'
          +objects[i].target.to[0].name ||objects[i].target.to[0].address+'</td<td>'
          +objects[i].object.subject+'</td</tr>';
      }
      document.body.innerHTML = str+'</table>';
    });
*/  </script>
</html>
