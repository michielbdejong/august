<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <style>
      nav { width:20em; float:left }
      article { width:40em; float:left }
      article textarea { width: 40em; height: 20em }
    </style>
  </head>
  <body>
    <nav style="display:none" >
      <h1>Contacts:</h1>
      <div id="searchWidget" style="display:block">
        Search: <input onkeyup="key();" id="in">  
        <span id="spinner" style="display:none"><h3>hmmmmmm...</h3></span>
        <ul id="results"></ul>
      </div>
      <ul id="target"></ul>
      <a href="https://accounts.google.com/o/oauth2/auth?scope=https://www.google.com/m8/feeds&response_type=code&redirect_uri=http://localhost:8000/&approval_prompt=force&state=/profile&client_id=709507725318.apps.googleusercontent.com&hl=cs&from_login=1&as=-70afdc9022b91924&pli=1&authuser=0">import from Google</a>
    </nav>
    <article style="display:none" >
      <h2>Compose:</h2>
      <textarea id="text"></textarea>
      <p>
        <input type="submit" value="Send" onclick="sendEmail();" />
      </p>
      <h2>History:</h2>
      <table id="history"><tr><td>timestamp</td><td>actor</td><td>text</td></tr></table>
    </article>
  </body>
  <script src="remotestorage.js"> </script>
  <script src="sockjs-0.3.min.js"> </script>
  <script>
    remoteStorage.displayWidget();
    RemoteStorage.defineModule('inbox', function(privClient, pubClient) {
      privClient.cache('', true);
      function asyncTreeTrav(numLeft, stack, cb) {
        var curr = stack.pop();
        privClient.getListing(curr).then(function(list) {
          list.sort(function(a, b) {
            return parseInt(a)-parseInt(b);
          });
          for(var i=0; i<list.length; i++) {
            if(list[i].substr(-1)=='/') {
              stack.push(curr+list[i]);
            } else {
              if(numLeft--) {
                privClient.getFile(curr+list[i]).then(cb);
              }
            }
          }
          if(numLeft) {
            asyncTreeTrav(numLeft, stack, cb);
          }
        });
      }
      return {
        exports: {
          getLast: function(num, cb) {
            asyncTreeTrav(num, ['email/'], cb);
            //asynchronous tree traversal: numLeft, nodesLeft, cb
            //take the last node
            //- if it's a leaf, pop it, cb it, and numLeft-1.
            //- if not, push its children
            privClient.getListing('email/').then(function(Ms) {
              var biggestMs = 0, thisMs;
              for(var i=0; i<Ms.length; i++) {
                thisMs = parseInt(Ms[i]);
                if(thisMs > biggestMs) {
                  biggestMs = thisMs;
                } 
              }
              privClient.getListing('email/'+biggestMs+'/').then(function(ks) {
                var biggestks = 0, thisks;
                for(var i=0; i<ks.length; i++) {
                  thisks = parseInt(ks[i]);
                  if(thisks > biggestks) {
                    biggestks = thisks;
                  } 
                }
                privClient.getListing('email/'+biggestMs+'/'+biggestks+'/').then(function(list) {
                  for(var i=0; i<list.length; i++) {
                    privClient.getFile('email/'+biggestMs+'/'+biggestks+'/'+list[i]).then(function(obj) {
                      cb(obj.data);
                    });
                  }
                });
              });
            });
          },
          getPrivClient: function() { return privClient; }
        }
      }
    });
    remoteStorage.access.claim('inbox', 'rw');
  </script>
</html>