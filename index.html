<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Meute - a foundation for unhosted social web apps</title>
  </head>
  <body>
    <h1>v0.4.3</h1>
    <p style="width:30em" >Meute is still very basic, but it can already help you build an app that combines
      <a href="http://remotestorage.io/">remotestorage</a> for per-user data storage and
      <a href="http://sockethub.org/">sockethub</a> for relaying messages from the browser to the outside world.
      The code is <a href="http://github.com/michielbdejong/meute">on github</a>.</p>
    <p style="width:30em" ><strong>NOTE:</strong> You currently need to use the
    <a href="https://github.com/sockethub/sockethub/tree/imap-fetch-from-to">imap-fetch-from-to branch</a> of sockethub for
    functions like `meute.email.fetchEmailsFromTo` to work correctly. Other functionality also requires at least the current master,
    because the config syntax changed, and some irc functionality was added since the v0.1.5 release of sockethub.</p>
    <p style="width:30em" >This page includes a build from source; view the page source to see which JavaScript files it includes.
      You can try out meute by opening your web console now, and typing 'meute.' to see which commands are available.
      The full 0.4 API is described in the <a href="https://github.com/michielbdejong/meute">readme</a>, but here is an example:</p>
    <pre id="pre1">(loading...)</pre>
    <p style="width:30em" >You can also do IndieWeb things with meute (provided you run a webserver with remoteStorage access to the public
    html folder, like <a href="https://github.com/michielbdejong/resite">reSite</a>):</p>
    <pre id="pre2">(loading...)</pre>
    <p style="width:30em" >The credentials you give in the addAccount calls will be encrypted with the master password using sjcl and stored
      in the respective remotestorage modules.</p>
  </body>
  <script src="upstream/sjcl.js"> </script>
  <script src="upstream/sockethub-client.js"></script>
  <script src="upstream/asrender.js"> </script>

  <!-- seems that hoodie has an undocumented dependency on jquery -->
  <script src="upstream/jquery.js"> </script>
  <script src="upstream/hoodie.js"> </script>

  <!-- core -->
  <script src="upstream/remotestorage.js/lib/promising.js"></script>
  <script src="upstream/remotestorage.js/src/remotestorage.js"></script>
  <script src="upstream/remotestorage.js/src/eventhandling.js"></script>
  <script src="upstream/remotestorage.js/src/wireclient.js"></script>
  <script src="upstream/remotestorage.js/src/discover.js"></script>
  <script src="upstream/remotestorage.js/src/authorize.js"></script>
  <script src="upstream/remotestorage.js/src/access.js"></script>
  <script src="upstream/remotestorage.js/src/env.js"></script>

  <!-- widget -->
  <script src="upstream/remotestorage.js/src/i18n.js"></script>
  <script src="upstream/remotestorage.js/src/assets.js"></script>
  <script src="upstream/remotestorage.js/src/widget.js"></script>
  <script src="upstream/remotestorage.js/src/view.js"></script>
  
  <!-- baseclient -->
  <script src="upstream/remotestorage.js/lib/tv4.js"></script>
  <script src="upstream/remotestorage.js/lib/Math.uuid.js"></script>
  <script src="upstream/remotestorage.js/src/baseclient.js"></script>
  <script src="upstream/remotestorage.js/src/baseclient/types.js"></script>

  <!-- caching -->
  <script src="upstream/remotestorage.js/src/caching.js"></script>
  <script src="upstream/remotestorage.js/src/sync.js"></script>
  <script src="upstream/remotestorage.js/src/cachinglayer.js"></script>
  <script src="upstream/remotestorage.js/src/indexeddb.js"></script>
  <script src="upstream/remotestorage.js/src/localstorage.js"></script>
  <script src="upstream/remotestorage.js/src/inmemorystorage.js"></script>

  <!-- the rest: -->
  <script src="upstream/remotestorage.js/src/modules.js"></script>
  <script src="upstream/remotestorage.js/src/debug/inspect.js"></script>
  <script src="upstream/remotestorage.js/src/legacy.js"></script>
  <script src="upstream/remotestorage.js/src/googledrive.js"></script>
  <script src="upstream/remotestorage.js/src/dropbox.js"></script>

  <script>
    //for debugging:
    var messageLogs = [],
      debugLogs = [];

    function d(p) {
      p.then(
        function(a) { console.log('success', a, JSON.stringify(a)); },
        function(a) { console.log('fail', a, JSON.stringify(a)); });
    }
    RemoteStorage._log = true;
    RemoteStorage.reset = function() {
      indexedDB.deleteDatabase('remotestorage');
      localStorage.clear();
    }
    function evalScript(path) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', path+'?refresh='+new Date().getTime(), true);
      xhr.onload = function() {
        eval(xhr.responseText);
        console.log('reloaded '+path);
      };
      xhr.send();
    }
    function reload() {
      evalScript('meute.js');
      setTimeout(function() {
        evalScript('meute-email.js');
        evalScript('meute-www.js');
      }, 1000);
      setTimeout(function() {
        meute.on('message', function(obj) { messageLogs.push(obj); console.log('meute message', obj); });
        meute.on('debug', function(obj) { debugLogs.push(obj); console.log('meute debug', obj); });
        meute.bootstrap();
      }, 2000);
    }

    function calcPage(oldest, newest, perPage) {
      var page = Math.floor((newest-oldest)/perPage)+1;
      return 'meute.email.fetch('+page+', '+perPage+') will get you ids '+(newest-(page*perPage))+' to '+(newest-((page-1)*perPage+1));
    }
    function benchmark(num, interval) {
      var setter, i=0, startTime = new Date().getTime();
      if (interval) {
        setter = setInterval(function() {
          remoteStorage.scope('/test/').storeFile('text/plain', 'test'+i, 'a');
          i++;
          if (i === num) {
            console.log('finished setting', (new Date().getTime() - startTime)/1000);
            clearInterval(setter);
          }
        }, interval);
      } else {
        for (i=0; i<num; i++) {
          remoteStorage.scope('/test/').storeFile('text/plain', 'test'+i, 'a');
        }
        console.log('finished setting', (new Date().getTime() - startTime)/1000);
      }

      setTimeout(function() {
        var timer = setInterval(function() {
          if (remoteStorage.local.putsRunning === 0
              && (remoteStorage.local.commitQueued === undefined || Object.keys(remoteStorage.local.commitQueued).length === 0)) {
            console.log('finished storing', (new Date().getTime() - startTime)/1000);
            clearInterval(timer);
//          } else {
//            console.log(remoteStorage.local.putsRunning + ' <- ' + Object.keys(remoteStorage.local.commitQueued).length);
          }
        }, 100);
      }, 1000);
    }

    //instantiate:
    remoteStorage = new RemoteStorage();
    remoteStorage.displayWidget();
    var remoteStorageReady = false;
    remoteStorage.on('ready', function() {
      remoteStorageReady = true;
    });
    RemoteStorage.enableChangeEvents = {
      local: false,
      window: false,
      remote: true,
      conflict: true
    };
    remoteStorage.access.claim('www', 'rw');
    remoteStorage.scope('/public/www/').cache('', 'ALL');
    function fireInitial() {
      var i=0;
      RemoteStorage.enableChangeEvents.local = true;
      remoteStorage.scope('/').on('change', function() {
        i++;
        if(i%1000===0) {
          console.log('change events... '+i);
        }
      });
      if (remoteStorageReady) {
        console.log('Calling fireInitial...');
        remoteStorage.fireInitial();
      } else {
        console.log('fireInitial will be called from the remoteStorage ready event...');
      }
    }
  </script>


  <script src="upstream/remotestorage-modules/utils/credentialsstore.js"> </script>
  <script src="upstream/remotestorage-modules/utils/prefixtree.js"> </script>
  <script src="upstream/remotestorage-modules/utils/syncedmap.js"> </script>
  <script src="upstream/remotestorage-modules/utils/syncedvar.js"> </script>

  <script src="upstream/remotestorage-modules/sockethub-credentials.js"> </script>
  <script src="upstream/remotestorage-modules/messages.js"> </script>
  <script src="upstream/remotestorage-modules/email-credentials.js"> </script>
  <script src="upstream/remotestorage-modules/irc-credentials.js"> </script>
  <script src="upstream/remotestorage-modules/twitter-credentials.js"> </script>
  <script src="upstream/remotestorage-modules/facebook-credentials.js"> </script>
  <script src="upstream/remotestorage-modules/contacts.js"> </script>
  <script src="upstream/remotestorage-modules/documents.js"> </script>
  <script src="upstream/remotestorage-modules/pgp.js"> </script>
  <script src="upstream/remotestorage-modules/pictures.js"> </script>

  <script src="meute.js"> </script>
  <script src="meute-email.js"> </script>
  <script src="meute-www.js"> </script>
  <script id="exampleCode1">
    meute.on('message', function(obj) { messageLogs.push(obj); console.log('meute message', obj); });
    meute.on('debug', function(obj) { debugLogs.push(obj); console.log('meute debug', obj); });
    meute.bootstrap();

    function step1() {
      meute.setMasterPassword('master');
    }
    function step2() {
      meute.addAccount('sockethub', 'wss://michielbdejong.com:10550/', '1234567890');
    }
    function step3() {
      meute.addAccount('irc', 'irc.freenode.net', 'nick12345');
    }
    function step4() {
      meute.join('irc', ['#meute']); //meute.join('irc', '#meute'); is also allowed when joining only one channel
    }
    function step5() {
      meute.send('irc', '#meute', 'hi');
    }
    function step6() {
      meute.leave('irc', ['#meute']); //meute.leave('irc', '#meute'); is also allowed when leaving only one channel
    }
    function step7() {
      meute.email.fetch(0, 50);
    }
    function step8() {
      var str = '';
      for (i=0; i<messageLogs.length; i++) {
        str += '' + i + ': ' + msgs[i].actor[0].address + '-' + msgs[i].object.subject + '\n';
      }
      return str;
    }

    document.getElementById('pre1').innerHTML = document.getElementById('exampleCode1').innerHTML.replace('<', '&gt;');
  </script>
  <script id="exampleCode2">
    function indieWebExampleStep1() {
      meute.www.loadTemplate('homepage.html');
      meute.www.loadPosts();
    }
    //...wait for the requests to complete...
    function indieWebExampleStep2() {
      meute.www.posts = JSON.parse(meute.www.posts);
      meute.www.publish('Posting from an unhosted meute instance');
    }
    
    document.getElementById('pre2').innerHTML = document.getElementById('exampleCode2').innerHTML.replace('<', '&gt;');
  </script>
</html>
