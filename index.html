<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <style>
      nav { width:20em; float:left }
      article { width:40em; float:left }
      article textarea { width: 40em; height: 20em }
    </style>
  </head>
  <body>
    <nav style="display:none" >
      <h1>Contacts:</h1>
      <div id="searchWidget" style="display:block">
        Search: <input onkeyup="key();" id="in">  
        <span id="spinner" style="display:none"><h3>hmmmmmm...</h3></span>
        <ul id="results"></ul>
      </div>
      <ul id="target"></ul>
      <a href="https://accounts.google.com/o/oauth2/auth?scope=https://www.google.com/m8/feeds&response_type=code&redirect_uri=http://localhost:8000/&approval_prompt=force&state=/profile&client_id=709507725318.apps.googleusercontent.com&hl=cs&from_login=1&as=-70afdc9022b91924&pli=1&authuser=0">import from Google</a>
    </nav>
    <article style="display:none" >
      <h2>Compose:</h2>
      <textarea id="text"></textarea>
      <p>
        <input type="submit" value="Send" onclick="sendEmail();" />
      </p>
      <h2>History:</h2>
    </article>
    <h2 id="convHead"></h2>
    <ul id="convList"></ul>
    <table id="history" border="1" ></table>
  </body>
  <script src="remotestorage.js"> </script>
  <script src="sockjs-0.3.min.js"> </script>
  <script>
    remoteStorage.displayWidget();
    RemoteStorage.defineModule('contacts', function(privClient, pubClient) {
      return {
        exports: {
          add: function(address, attributes) {
            return privClient.storeObject('contact', address, JSON.stringify(attributes));
          },
          getList: function() {
            return privClient.getAll('');
          }
        }
      };
    });
    RemoteStorage.defineModule('inbox', function(privClient, pubClient) {
      privClient.cache('', true);
      function asyncTreeTrav(numLeft, stack, cb) {
        var curr = stack.pop();
        console.log('asyncTreeTrav', numLeft, stack, curr);
        privClient.getListing(curr).then(function(list) {
          list.sort(function(a, b) {
            return parseInt(a)-parseInt(b);
          });
          for(var i=0; i<list.length; i++) {
            if(list[i].substr(-1)=='/') {
              stack.push(curr+list[i]);
            } else {
              if((numLeft--)>0) {
                privClient.getFile(curr+list[i]).then(function(obj) {
                  var msg;
                  try {
                    msg = JSON.parse(obj.data);
                  } catch(e) {
                    msg = e;
                  }
                  cb(msg);
                });
              }
            }
          }
          if(numLeft>0) {
            asyncTreeTrav(numLeft, stack, cb);
          }
        });
      }
      function extractParticipants(obj) {
        var ret = [];
        console.log('extractParticipants', obj);
        if(typeof(obj)=='string') {
          console.log('string - returning', [obj]);
          return [obj];
        } else if(Array.isArray(obj)) {
          for(var i=0; i<obj.length; i++) {
            ret.push(extractParticipants(obj[i]));
          }
          console.log('array - returning', ret);
          return ret;
        } else if(typeof(obj)=='object' && typeof(obj.address)=='string') {
          console.log('object - returning', obj.address);
          remoteStorage.contacts.add(obj.address, obj);
          return [obj.address];
        } else if((typeof(obj)=='object') && ((typeof(obj.to)=='object') || (typeof(obj.cc)=='object') || (typeof(obj.bcc)=='object'))) {
          ret = extractParticipants(obj.to).concat(extractParticipants(obj.cc)).concat(extractParticipants(obj.bcc));
          console.log('to/cc/bcc - returning', ret);
          return ret;
        } else {
          console.log('returning nothing');
          return [];
        }
      }
      function determineGroup(obj) {
        var memberships = {
          'unhosted@googlegroups.com': {'anything@michielbdejong.com':true, 'nick@silverbucket.net':true}
        };
        var all = [];
        if(typeof(obj.actor) != 'undefined') {
          all = all.concat(extractParticipants(obj.actor));
        }
        if(typeof(obj.target) != 'undefined') {
          all = all.concat(extractParticipants(obj.target));
        }
        console.log('all', all);
        var groups = [];
        for(var i=0; i<all.length; i++) {
          if(memberships[all[i]]) {
            groups.push(all[i]);
          }
        }
        var filtered=[], alreadyInGroup;
        for(var i=0; i<all.length; i++) {
          alreadyInGroup=false;
          for(var j=0; j<groups.length; j++) {
            if(memberships[groups[j]][all[i]]) {
              alreadyInGroup=true;
              break;
            }
          }
          if(!alreadyInGroup) {
            filtered.push(all[i]);
          }
        }
        return filtered
          .sort()
          .join(',');
      }
      return {
        exports: {
          getLast: function(num, cb) {
            asyncTreeTrav(num, ['email/'], cb);
          },
          getLastGrouped: function(num, cb) {
            var groups = [], numDone = 0;
            asyncTreeTrav(num, ['email/'], function(obj) {
              try {
                var group = determineGroup(obj);
                console.log('group of ', obj, ' is ', group);
                for(var i=0; i<groups.length; i++) {
                  if(groups[i].group==group) {
                    groups[i].messages.push(obj);
                    numDone++;
                    if(numDone==num) {
                      cb(groups);
                    }
                    return;
                  }
                }//group is new:
                groups.push({
                  group: group,
                  messages: [obj]
                });
                numDone++;
                if(numDone==num) {
                  cb(groups);
                }
              } catch(e) {
                console.log('yo', e.message);
              }
            });
          },
          getPrivClient: function() { return privClient; }
        }
      }
    });
    function renderContact(contact) {
      return contact.name;
    }
    function renderPost(obj) {
      return obj.subject;
    }

    var contactSearch = [], currConv=0;
    function displayConv(conv) {
      document.getElementById('convHead').innerHTML=conv.group;
      var str = ''
      for(var i=0; i<conv.messages.length; i++) {
        str += '<li>'+conv.messages[i].actor[0].name+': ['+conv.messages[i].object.subject+'] - '+conv.messages[i].object.text+'</li>';
      }
      document.getElementById('convHead').innerHTML=conv.group;
      document.getElementById('convList').innerHTML=str;
    }
    function setConv(i) {
      currConv = i;
      remoteStorage.inbox.getLastGrouped(10, function(conversations) {
        console.log(conversations);
        var str = '<tr><td>group</td><td>actor</td><td>subject</td></tr>';
        for(var i=0; i<conversations.length;i++) {
          if(currConv==i) {
            str += '<tr style="background-color:blue"><td>'+conversations[i].group.substring(0,50)+'</td><td>'
              +conversations[i].messages[0].actor[0].name.substring(0,50)
              +'</td><td>'+conversations[i].messages[0].object.subject.substring(0,50)+'</td></tr>';
            displayConv(conversations[i]);
          } else {
            str += '<tr onclick="setConv('+i+');"><td>'+conversations[i].group.substring(0,50)
              +'</td><td>'+conversations[i].messages[0].actor[0].name.substring(0,50)
              +'</td><td>'+conversations[i].messages[0].object.subject.substring(0,50)+'</td></tr>';
          }
        }
        document.getElementById('history').innerHTML = str;
      });
    }
    //..
    remoteStorage.access.claim('inbox', 'rw');
    setConv(0);
    remoteStorage.contacts.getList().then(function(contacts) {
      for(var i in contacts) {
        try {
          obj = JSON.parse(contacts[i]);
          contactSearch.push(obj);
        } catch(e) {
        }
      }     
    });
    function search(prefix) {
      for(var i=0; i<contactSearch.length; i++) {
        if(contactSearch[i].name.substring(0, prefix.length)==prefix) {
          return contactSearch[i];
        }
      }
    }
  </script>
</html>