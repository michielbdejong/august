<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Meute - an unhosted messages/contacts/search app</title>
    <style>
      body { font:15px sans-serif; line-height:1.4em; color:#222 }
      nav {float:left; margin:3em}
      nav div { border-style:solid; border-radius:1em; margin: 1em; padding: 1em}
      nav div table tr td img { width:4em; height:4em; border-radius:1em }
      article table tr td img { width:3em; height:3em; border-radius:1em }
      article {float:left; margin-top:4em; padding:1em; border-style:solid; border-radius:1em}
    </style>
  </head>
  <body>
    <input style="float:right;margin-top:.75em;margin-right:15em" type="submit" value="load mock data" onmousedown="loadMockData();" />
    <nav>
      <div class="box mainscreen">
        <h2>Search:</h2>
        <input oninput="filterContacts(this.value);">
      </div>
      <div class="box mainscreen" >
        <h2>Contacts:</h2>
        <table id="contactsTable">
        </table>
      </div>
      <div class="box mainscreen" >
        <h2>Suggestions:</h2>
        <table id="suggestionsTable">
        </table>
      </div>
      <div class="box composescreen">
        <h2 style="display:inline">Message to:</h2>
        <table id="toTable">
        </table>
      </div>
      <div class="box readscreen">
        <h2 style="display:inline">Message from:</h2>
        <table id="fromTable">
        </table>
      </div>
    </nav>
    <article class="box mainscreen" onmousedown="showBoxes('readscreen');">
      <h2>Messages:</h2>
      <table id="messagesTable" border="1">
      </table>
    </article>
    <article class="box composescreen">
      <div>
        <input type="submit" value="back" onmousedown="showBoxes('mainscreen');">
        <input type="submit" value="send" onmousedown="sendMsg();"> (first line is email subject)
      </div>
      <div>
        <textarea id="compose" style="width:100%;height:6em"></textarea>
      </div>
    </article>
    <article class="box readscreen" style="width:40em">
      <div>
        <input type="submit" value="back" onmousedown="showBoxes('mainscreen');">
        <input type="submit" value="reply" onmousedown="showBoxes('composescreen');">
      </div>
      <div>
        <p id="readp" style="width:100%;word-wrap:break-word">
        </p>
      </div>
    </article>
  </body>
  <script src="app.js"> </script>
  <script src="remotestorage.js"> </script>
  <script src="inbox.js"> </script>
  <script src="sockethub-credentials.js"> </script>
  <script>
    remoteStorage.contacts = {
      add: function(list) {
        if(Array.isArray(list)) {
          for(var i=0; i<list.length; i++) {
            contactsInMem[list[i].address] = list[i];
          }
        }
      }
    };
    function displayLast(num) {
      var i=0;
      remoteStorage.inbox.getLast(num, function(msg) {
        remoteStorage.contacts.add(msg.actor);
        if(typeof(msg.target)=='object' && !Array.isArray(msg.target)) {
          remoteStorage.contacts.add(msg.target.to);
          remoteStorage.contacts.add(msg.target.cc);
          remoteStorage.contacts.add(msg.target.bcc);
        }
        messagesInMem[(msg.object?msg.object.messageId:msg.timestamp)] = {
          name: (msg.actor?msg.actor[0].name:''),
          subject: (msg.object ? msg.object.subject:JSON.stringify(msg)),
          text: (msg.object ? msg.object.text : '')
        };
        i++;
        if(i>=num) {
          showMessages();
          showContacts();
        }
      });
    }
    var messagesInMem={}, contactsInMem={}, inReplyTo, toAddress;
    remoteStorage.displayWidget();
    remoteStorage.access.claim('inbox', 'r');
    remoteStorage.access.claim('sockethub-credentials', 'r');
    displayLast(50);
    var sock, send = function() { console.log('not ready'); };
    remoteStorage.sockethubCredentials.getUrl().then(function(url) {
      sock = new WebSocket(url.data);
      sock.onmessage=function(msg) { console.log('sock msg', msg.data); };
      sock.onopen=function(msg) { console.log('sock open', msg); };
      sock.onclose=function(msg) { console.log('sock closed', msg); };
      sock.onerror=function(msg) { console.log('sock error', msg); };
      remoteStorage.sockethubCredentials.getToken().then(function(token) {
        send = function(obj) { 
          obj.token = token.data.trim();
          sock.send(JSON.stringify(obj));
          console.log('sock sent', obj);
        };
      });
    });
  </script>
</html>
