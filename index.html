<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Meute - a foundation for unhosted social web apps</title>
  </head>
  <body>
    <h1>v0.4.1</h1>
    <p style="width:30em" >Meute is still very basic, but it can already help you build an app that combines
      <a href="http://remotestorage.io/">remotestorage</a> for per-user data storage and
      <a href="http://sockethub.org/">sockethub</a> for relaying messages from the browser to the outside world.
      The code is <a href="http://github.com/michielbdejong/meute">on github</a>.</p>
    <p style="width:30em" >This page includes a build from source; view the page source to see which JavaScript files it includes.
      You can try out meute by opening your web console now, and typing 'meute.' to see which commands are available.
      The full 0.4 API is described in the <a href="https://github.com/michielbdejong/meute">readme</a>, but here is an example:
    <pre id="codeExample">(loading...)</pre>
    <p>The credentials you give in the addAccount calls will be encrypted with the master password using sjcl and stored
      in the respective remotestorage modules.</p>
  </body>
  <script src="upstream/sjcl.js"> </script>
  <script src="upstream/sockethub-client.js"></script>
  <script src="upstream/asrender.js"> </script>

  <!-- core -->
  <script src="upstream/remotestorage.js/lib/promising.js"></script>
  <script src="upstream/remotestorage.js/src/remotestorage.js"></script>
  <script src="upstream/remotestorage.js/src/eventhandling.js"></script>
  <script src="upstream/remotestorage.js/src/wireclient.js"></script>
  <script src="upstream/remotestorage.js/src/discover.js"></script>
  <script src="upstream/remotestorage.js/src/authorize.js"></script>
  <script src="upstream/remotestorage.js/src/access.js"></script>
  <script src="upstream/remotestorage.js/src/env.js"></script>

  <!-- widget -->
  <script src="upstream/remotestorage.js/src/i18n.js"></script>
  <script src="upstream/remotestorage.js/src/assets.js"></script>
  <script src="upstream/remotestorage.js/src/widget.js"></script>
  <script src="upstream/remotestorage.js/src/view.js"></script>
  
  <!-- baseclient -->
  <script src="upstream/remotestorage.js/lib/tv4.js"></script>
  <script src="upstream/remotestorage.js/lib/Math.uuid.js"></script>
  <script src="upstream/remotestorage.js/src/baseclient.js"></script>
  <script src="upstream/remotestorage.js/src/baseclient/types.js"></script>

  <!-- caching -->
  <script src="upstream/remotestorage.js/src/caching.js"></script>
  <script src="upstream/remotestorage.js/src/sync.js"></script>
  <script src="upstream/remotestorage.js/src/cachinglayer.js"></script>
  <script src="upstream/remotestorage.js/src/indexeddb.js"></script>
  <script src="upstream/remotestorage.js/src/localstorage.js"></script>
  <script src="upstream/remotestorage.js/src/inmemorystorage.js"></script>

  <!-- the rest: -->
  <script src="upstream/remotestorage.js/src/modules.js"></script>
  <script src="upstream/remotestorage.js/src/debug/inspect.js"></script>
  <script src="upstream/remotestorage.js/src/legacy.js"></script>
  <script src="upstream/remotestorage.js/src/googledrive.js"></script>
  <script src="upstream/remotestorage.js/src/dropbox.js"></script>

  <script>
    //for debugging:
    function d(p) {
      p.then(
        function(a) { console.log('success', a, JSON.stringify(a)); },
        function(a) { console.log('fail', a, JSON.stringify(a)); });
    }
    RemoteStorage._log = true;
    RemoteStorage.reset = function() {
      indexedDB.deleteDatabase('remotestorage');
      localStorage.clear();
    }
    function evalScript(path) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', path+'?refresh='+new Date().getTime(), true);
      xhr.onload = function() {
        eval(xhr.responseText);
        console.log('reloaded '+path);
      };
      xhr.send();
    }
    function reload() {
      evalScript('meute.js');
      setTimeout(function() {
        evalScript('meute-email.js');
        evalScript('meute-www.js');
      }, 1000);
      setTimeout(function() {
        meute.on('message', function(obj) { console.log('meute message', obj); });
        meute.on('debug', function(obj) { console.log('meute debug', obj); });
        meute.bootstrap();
      }, 2000);
    }

    //instantiate:
    remoteStorage = new RemoteStorage();
    var remoteStorageReady = false;
    remoteStorage.on('ready', function() {
      remoteStorageReady = true;
    });
    function fireInitial() {
      var i=0;
      remoteStorage.scope('/').on('change', function() {
        i++;
        if(i%1000===0) {
          console.log('change events... '+i);
        }
      });
      if (remoteStorageReady) {
        console.log('Calling fireInitial...');
        remoteStorage.fireInitial();
      } else {
        console.log('Will call fireInitial when remoteStorage ready is fired');
        remoteStorage.on('ready', function() {
          remoteStorage.fireInitial();
        });
      }
    }
  </script>


  <script src="upstream/remotestorage-modules/utils/credentialsstore.js"> </script>
  <script src="upstream/remotestorage-modules/utils/prefixtree.js"> </script>
  <script src="upstream/remotestorage-modules/utils/syncedmap.js"> </script>
  <script src="upstream/remotestorage-modules/utils/syncedvar.js"> </script>

  <script src="upstream/remotestorage-modules/sockethub.js"> </script>
  <script src="upstream/remotestorage-modules/inbox.js"> </script>
  <script src="upstream/remotestorage-modules/email.js"> </script>
  <script src="upstream/remotestorage-modules/irc.js"> </script>
  <script src="upstream/remotestorage-modules/twitter.js"> </script>
  <script src="upstream/remotestorage-modules/facebook.js"> </script>

  <script src="meute.js"> </script>
  <script src="meute-email.js"> </script>
  <script src="meute-www.js"> </script>
  <script>
    meute.on('message', function(obj) { console.log('meute message', obj); });
    meute.on('debug', function(obj) { console.log('meute debug', obj); });
    meute.bootstrap();

    function step1() {
      meute.setMasterPassword('master');
    }
    function step2() {
      meute.addAccount('sockethub', 'wss://michielbdejong.com:10550/', '1234567890');
    }
    function step3() {
      meute.addAccount('irc', 'irc.freenode.net', 'nick12345');
    }
    function step4() {
      meute.join('irc', ['#meute']); //meute.join('irc', '#meute'); is also allowed when joining only one channel
    }
    function step5() {
      meute.send('irc', '#meute', 'hi');
    }
    function step6() {
      meute.leave('irc', ['#meute']); //meute.leave('irc', '#meute'); is also allowed when leaving only one channel
    }
    document.getElementsByTagName('pre')[0].innerHTML = 
        document.getElementsByTagName('script')[document.getElementsByTagName('script').length-1].innerHTML;
  </script>
</html>