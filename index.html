<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Meute - a Solid chat app</title>
  </head>
  <body>
    <h1>v0.8</h1>
    <p style="width:30em" >Meute is still very basic.</p>
    <div id="login-state"></div>
    <input type="submit" value="Log in" onclick="login();">
    <input type="submit" value="Log out" onclick="logout();">
    <h1>Chats</h2>
    <input type="submit" value="Refresh" onclick="refreshChatList();">
    <ul id="chat-list"></ul>
  </body>
  <script src="scripts/jquery.js"></script>
  <script src="https://solid.github.io/solid-auth-client/dist/solid-auth-client.bundle.js"></script>
  <script src="https://linkeddata.github.io/rdflib.js/dist/rdflib.min.js"></script>
  <script>
  solid.auth.trackSession(session => {
    if (!session) {
      console.log('The user is not logged in');
      document.getElementById('login-state').innerHTML = 'Not logged in.';
    } else {
      console.log(`The user is ${session.webId}`);
      document.getElementById('login-state').innerHTML = `Logged in as ${session.webId}.`;
    }
  })
  function logout() {
    solid.auth.logout()
      .then(() => alert('Goodbye!'));
  }
  async function login() {
    let session = await solid.auth.currentSession();
    let popupUri = 'https://solid.community/common/popup.html';
    if (!session)
      session = await solid.auth.popupLogin({ popupUri });
    alert(`Logged in as ${session.webId}`);
  }
  async function refreshChatList() {
    const ldp = $rdf.Namespace('http://www.w3.org/ns/ldp#');
    const store = $rdf.graph();
    const fetcher = new $rdf.Fetcher(store);

    // Load the person's hosted chats into the store
    const chats = 'https://michielbdejong.inrupt.net/chats/';
    await fetcher.load(chats);
    console.log('fetcher loaded', fetcher, store);
    const chatsList = store.match(null, $rdf.Namespace("http://www.w3.org/ns/ldp#")("contains")).map(e => {
      const c =  document.createElement('LI');
      c.appendChild(document.createTextNode(e.object.value));
      document.getElementById('chat-list').appendChild(c);
    });
  }
  </script>
</html>
